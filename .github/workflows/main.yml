on: push
name: ðŸš€ Deploy website on push
jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v5

      - name: Generate .env
        run: |
          echo APP_Name=${{secrets.APP_NAME}} > .env
          echo APP_ENV=${{secrets.APP_ENV}} >> .env
          echo APP_KEY=${{secrets.APP_KEY}} >> .env
          echo APP_DEBUG=${{secrets.APP_DEBUG}} >> .env
          echo APP_URL=${{secrets.APP_URL}} >> .env

          echo APP_LOCALE=${{secrets.APP_LOCALE}} >> .env
          echo APP_FALLBACK_LOCALE=${{secrets.APP_FALLBACK_LOCALE}} >> .env
          echo APP_FAKER_LOCALE=${{secrets.APP_FAKER_LOCALE}} >> .env

          echo APP_MAINTENANCE_DRIVER=${{secrets.APP_MAINTENANCE_DRIVER}} >> .env
          echo # APP_MAINTENANCE_STORE=${{secrets.APP_MAINTENANCE_STORE}} >> .env

          echo PHP_CLI_SERVER_WORKERS=${{secrets.PHP_CLI_SERVERS_WORKERS}} >> .env

          echo BCRYPT_ROUNDS=1${{secrets.BCRYPT_ROUNDS}} >> .env

          echo LOG_CHANNEL=${{secrets.LOG_CHANNEL}} >> .env
          echo LOG_STACK=${{secrets.LOG_STACK}} >> .env
          echo LOG_DEPRECATIONS_CHANNEL=${{secrets.LOG_DEPRECATIONS_CHANNEL}} >> .env
          echo LOG_LEVEL=${{secrets.LOG_LEVEL}} >> .env

          echo DB_CONNECTION=${{secrets.DB_CONNECTION}} >> .env
          echo DB_HOST=${{secrets.DB_HOST}} >> .env
          echo DB_PORT=${{secrets.DB_PORT}} >> .env
          echo DB_DATABASE=${{secrets.DB_DATABASE}} >> .env
          echo DB_USERNAME=${{secrets.DB_USERNAME}} >> .env
          echo DB_PASSWORD=${{secrets.DB_PASSWORD}} >> .env

          echo SESSION_DRIVER=${{secrets.SESSION_DRIVER}} >> .env
          echo SESSION_LIFETIME=${{secrets.SESSION_LIFETIME}} >> .env
          echo SESSION_ENCRYPT=${{secrets.SESSION_ENCRYPT}} >> .env
          echo SESSION_PATH=${{secrets.SESSION_PATH}} >> .env
          echo SESSION_DOMAIN=${{secrets.DOMAIN}} >> .env

          echo BROADCAST_CONNECTION=${{secrets.BROADCAST_CONNECTION}} >> .env
          echo FILESYSTEM_DISK=${{secrets.FILESYSTEM_DISK}} >> .env
          echo QUEUE_CONNECTION=${{secrets.QUEUE_CONNECTION}} >> .env

          echo CACHE_STORE=${{secrets.CACHE_STORE}} >> .env
          echo # CACHE_PREFIX=${{secrets.CACHE_PREFIX}} >> .env

          echo MEMCACHED_HOST=${{secrets.MEMCACHED_HOST}} >> .env

          echo REDIS_CLIENT=${{secrets.REDIS_CLIENT}} >> .env
          echo REDIS_HOST=${{secrets.REDIS_HOST}} >> .env
          echo REDIS_PASSWORD=${{secrets.REDIS_PASSWORD}} >> .env
          echo REDIS_PORT=${{secrets.REDIS_PORT}} >> .env

          echo MAIL_MAILER=${{secrets.MAIL_MAILER}} >> .env
          echo MAIL_SCHEME=${{secrets.MAIL_SCHEME}} >> .env
          echo MAIL_HOST=${{secrets.MAIL_HOST}} >> .env
          echo MAIL_PORT=${{secrets.MAIL_PORT}} >> .env
          echo MAIL_USERNAME=${{secrets.MAIL_USERNAME}} >> .env
          echo MAIL_PASSWORD=${{secrets.MAIL_PASSWORD}} >> .env
          echo MAIL_FROM_ADDRESS=${{secrets.MAIL_FROM_ADDRESS}} >> .env
          echo MAIL_FROM_NAME="${APP_NAME}" >> .env

          echo AWS_ACCESS_KEY=${{secrets.AWS_ACCESS_KEY}} >> .env
          echo AWS_SECRET_ACCESS_KEY=${{secrets.AWS_SECRET_ACCESS_KEY}} >> .env
          echo AWS_DEFAULT_REGION=${{secrets.AWS_DEFAULT_REGION}} >> .env
          echo AWS_BUCKET=${{secrets.AWS_BUCKET}} >> .env
          echo AWS_USE_PATH_STYLE_ENDPOINT=${{secrets.AWS_USE_PATH_STYLE_ENDPOINT}} >> .env

          echo VITE_APP_NAME="${APP_NAME}" >> .env

          echo DISCORD_CLIENT_ID=${{secrets.DISCORD_CLIENT_ID}} >> .env
          echo DISCORD_CLIENT_SECRET=${{secrets.DISCORD_CLIENT_SECRET}} >> .env
          echo DISCORD_REDIRECT_URI=${{secrets.DISCORD_REDIRECT_URI}} >> .env
          echo DISCORD_AVATAR_GIF=${{secrets.DISCORD_AVATAR_GIF}} >> .env
          echo DISCORD_EXTENSION_DEFAULT=${{secrets.DISCORD_EXTENSION_DEFAULT}} >> .env

          echo TWITCH_CLIENT_ID=${{secrets.TWITCH_CLIENT_ID}} >> .env
          echo TWITCH_CLIENT_SECRET=${{secrets.TWITCH_CLIENT_SECRET}} >> .env
          echo TWITCH_REDIRECT_URI=${{secrets.TWITCH_REDIRECT_URI}} >> .env

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: latest
          node-version-file: package.json
          check-latest: true
          cache-dependency-path: package-lock.json

      - name: Build Project
        run: |
          npm install
          npm run build

      - name: ðŸ“‚ Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{secrets.ftp_server}}
          username: ${{secrets.ftp_username}}
          password: ${{ secrets.ftp_password }}
          server-dir: ${{secrets.ftp_server_dir}}
          log-level: verbose

      - name: Setup
        uses: appleboy/ssh-action@v1
        with:
          host: ${{secrets.SSH_HOST}}
          username: ${{secrets.SSH_USER}}
          key: ${{secrets.SSH_PRIVATE_KEY}}
          script: ./setup.sh
